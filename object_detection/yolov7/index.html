<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://www.data-mining.co.nz/applied-deep-learning/object_detection/yolov7/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Yolov7 - Applied Deep Learning</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Yolov7";
    var mkdocs_page_input_path = "object_detection/yolov7.md";
    var mkdocs_page_url = "/applied-deep-learning/object_detection/yolov7/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Applied Deep Learning</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../prerequisites/">Prerequisites</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Image classification</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/frameworks/">Frameworks</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Object detection</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../frameworks/">Frameworks</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Instance segmentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../instance_segmentation/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../instance_segmentation/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../instance_segmentation/frameworks/">Frameworks</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Image segmentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/frameworks/">Frameworks</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Speech-to-text</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../speech_to_text/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../speech_to_text/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../speech_to_text/frameworks/">Frameworks</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Applied Deep Learning</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Yolov7</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/waikato-datamining/applied-deep-learning/edit/main/docs/object_detection/yolov7.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="https://github.com/WongKinYiu/yolov7">Yolov7</a> represents the implementation of 
<a href="https://arxiv.org/abs/2207.02696">YOLOv7: Trainable bag-of-freebies sets new state-of-the-art for real-time object detectors</a>. 
Custom docker images with additional tools are available from here:</p>
<p><a href="https://github.com/waikato-datamining/pytorch/tree/master/yolov7">https://github.com/waikato-datamining/pytorch/tree/master/yolov7</a></p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">#</a></h2>
<p>Make sure you have the directory structure created as outlined in the <a href="../../prerequisites/">Prerequisites</a>.</p>
<h2 id="data">Data<a class="headerlink" href="#data" title="Permanent link">#</a></h2>
<p>In this example, we will use the <a href="https://datasets.cms.waikato.ac.nz/ufdl/american-sign-language-letters/">American Sign Language Letters</a>
dataset, which consists of sets of images of hands, one per letter in the English alphabet (26 labels).</p>
<p>Download the dataset from the following URL into the <em>data</em> directory and extract it:</p>
<p><a href="https://datasets.cms.waikato.ac.nz/ufdl/data/american-sign-language-letters/american-sign-language-letters-voc.zip">https://datasets.cms.waikato.ac.nz/ufdl/data/american-sign-language-letters/american-sign-language-letters-voc.zip</a></p>
<p>Once extracted, rename the <em>voc</em> directory to <em>sign-voc</em>.</p>
<p>Now we have to convert the format from <em>VOC XML</em> into <em>YOLO</em>. We can do this by using the 
<a href="https://github.com/waikato-ufdl/wai-annotations">wai.annotations</a> library. 
At the same time, we can split the dataset into <em>train</em>, <em>validation</em> and <em>test</em> subsets.</p>
<p>From within the <code>applied_deep_learning</code> directory, run the following command:</p>
<pre><code class="language-bash">docker run -u $(id -u):$(id -g) \
  -v `pwd`:/workspace \
  -t waikatoufdl/wai.annotations:latest \
  wai-annotations convert \
    from-voc-od \
      -i &quot;/workspace/data/sign-voc/*.xml&quot; \
    to-yolo-od \
      -o /workspace/data/sign-yolo-split \
      --labels /workspace/data/sign-yolo-split/labels.txt \
      --labels-csv /workspace/data/sign-yolo-split/labels.csv \
      --split-names train val test \
      --split-ratios 70 15 15
</code></pre>
<p><strong>NB:</strong> At the time of writing, the yolo plugin for wai.annotations still had a bug which 
creates empty top-level directories when splitting datasets via <code>--split-names</code>. In the 
<code>sign-yolo-split</code> directory, you can safely remove the <code>train</code>, <code>test</code> and <code>val</code> directories, 
since the actual splits are below the <code>images</code> and <code>labels</code> directories:</p>
<pre><code class="language-bash">rm -fR data/sign-yolo-split/train data/sign-yolo-split/test data/sign-yolo-split/val
</code></pre>
<p>Finally, download the <a href="../img/dataset7.yaml">dataset7.yaml</a> file, place it in the <code>sign-yolo-split</code>
directory. It contains information about the dataset directory, the splits and the class labels.
Since the labels can come out in a random order, you need to update the labels in the yaml file
with the ones that got output in the <code>labels.txt</code> file. You can automatically quote the
comma-separated list using the following command:</p>
<pre><code class="language-bash">cat data/sign-yolo-split/labels.txt | sed s/,/\',\'/g | sed s/^/\'/g | sed s/$/\'/g
</code></pre>
<h2 id="training">Training<a class="headerlink" href="#training" title="Permanent link">#</a></h2>
<p>For training, we will use the following docker image:</p>
<pre><code>waikatodatamining/pytorch-yolov7:2022-10-08_cuda11.1
</code></pre>
<p>If you do not have a GPU, you can use the CPU-only image:</p>
<pre><code>waikatodatamining/pytorch-yolov7:2022-01-21_cpu
</code></pre>
<p>The training script is called <code>yolov7_train</code>, for which we can invoke the help screen as follows:</p>
<pre><code class="language-bash">docker run -t waikatodatamining/pytorch-yolov7:2022-10-08_cuda11.1 yolov7_train --help 
</code></pre>
<p>Since we will be performing transfer larning, we need to download a base model to use for training. 
Yolov7 offers different models, which differ in speed and accuracy. We will use the <em>fastest</em> one 
called <code>yolov7_training.pt</code> from the <code>v0.1</code> release:</p>
<p><a href="https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7_training.pt">https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7_training.pt</a></p>
<p>Download it and place it in the <code>models</code> directory.</p>
<p>It is good practice creating a separate sub-directory for each training run, with a directory name that hints at
what dataset and model were used. So for our first training run, which will use mainly default parameters, we will 
create the following directory in the <code>output</code> folder:</p>
<pre><code>sign-yolov7
</code></pre>
<p>Next, we need to download two more configuration files into our output directory:</p>
<ul>
<li>
<p><a href="https://raw.githubusercontent.com/WongKinYiu/yolov7/072f76c72c641c7a1ee482e39f604f6f8ef7ee92/cfg/training/yolov7.yaml">yolov7.yaml</a> (architecture)</p>
<p>adjust the <code>nc</code> parameter and just 26 instead of 80</p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/WongKinYiu/yolov7/072f76c72c641c7a1ee482e39f604f6f8ef7ee92/data/hyp.scratch.custom.yaml">hyp.scratch.custom.yaml</a> </p>
<p>here you can adjust training parameters and also tweak basic image augmentation methods</p>
</li>
</ul>
<p>Since the image size should be a multiple of 32, we use 416 for this experiment.</p>
<p>Kick off the training with the following command:</p>
<pre><code class="language-bash">docker run \
  -u $(id -u):$(id -g) \
  --shm-size 8G \
  --gpus=all \
  -v `pwd`:/workspace \
  -t waikatodatamining/pytorch-yolov7:2022-10-08_cuda11.1 \
  yolov7_train \
  --workers 1 \
  --device 0 \
  --batch-size 8 \
  --epochs 50 \
  --data /workspace/data/sign-yolo-split/dataset7.yaml \
  --img 416 416 \
  --weights /workspace/models/yolov7_training.pt \
  --project /workspace/output \
  --name sign-yolov7 \
  --exist-ok \
  --hyp /workspace/output/sign-yolov7/hyp.scratch.custom.yaml \
  --cfg /workspace/output/sign-yolov7/yolov7.yaml
</code></pre>
<h2 id="predicting">Predicting<a class="headerlink" href="#predicting" title="Permanent link">#</a></h2>
<p>Using the <code>yolov7_predict_poll</code> script, we can batch-process images placed in the <code>predictions/in</code> directory
as follows (e.g., from our <em>test</em> subset): </p>
<pre><code class="language-bash">docker run \
  -u $(id -u):$(id -g) \
  --gpus=all \
  -v `pwd`:/workspace \
  -t waikatodatamining/pytorch-yolov7:2022-10-08_cuda11.1 \
  yolov7_predict_poll \
  --model /workspace/output/sign-yolov7/weights/best.pt \
  --no_trace \
  --prediction_in /workspace/predictions/in \
  --prediction_out /workspace/predictions/out
</code></pre>
<p><strong>Notes</strong> </p>
<ul>
<li>The predictions get output in <a href="https://github.com/waikato-ufdl/wai-annotations-roi">ROI CSV format</a>.</li>
<li>You can view the predictions with the ADAMS <em>Preview browser</em> and, e.g., the <em>ObjectLocationsFromSpreadSheet</em>
  handler. You need to configure this generic handler via the <code>...</code> button, entering the columns 
  for the bounding box (<code>x0</code>, <code>y0</code>, <code>x1</code>, <code>y1</code>) and the label (<code>label_str</code>) of the 
  <code>reader</code> (<code>ObjectLocationsSpreadSheetReader</code>).</li>
</ul>
<p><strong>Example prediction</strong></p>
<p><img alt="Screenshot" src="../img/yolov7-A2_jpg.rf.e4d1f7a2679ab0140ad27a794db563c9.jpg" /> </p>
<p><img alt="Screenshot" src="../img/yolov7-I3_jpg.rf.13d13da81962b86db3705de1b79f984a.jpg" /></p>
<h2 id="exporting-to-onnx-optional">Exporting to ONNX (optional)<a class="headerlink" href="#exporting-to-onnx-optional" title="Permanent link">#</a></h2>
<p>Before we can use our trained model, we will need to export it to <a href="https://onnx.ai/">ONNX format</a>
using the <code>yolov7_export</code> script:</p>
<pre><code class="language-bash">docker run \
  -u $(id -u):$(id -g) \
  --gpus=all \
  -v `pwd`:/workspace \
  -t waikatodatamining/pytorch-yolov7:2022-10-08_cuda11.1 \
  yolov7_export \
  --weights /workspace/output/sign-yolov7/weights/best.pt \
  --grid \
  --end2end \
  --simplify \
  --topk-all 26 \
  --iou-thres 0.65 \
  --conf-thres 0.35 \
  --img-size 416 416 \
  --max-wh 416
</code></pre>
<p>This will create a file called <code>best.onnx</code> in the output directory.</p>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">#</a></h2>
<ul>
<li>If you are re-using a dataset that was used by another YolovX framework, you
  may get strange error messages when reading the data. This can be due to 
  incompatible cache files that get generated to speed up loading the data. 
  Make sure to remove all files in the <code>labels</code> directory that have a <code>.cache</code> 
  extension.</li>
</ul>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/waikato-datamining/applied-deep-learning/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
