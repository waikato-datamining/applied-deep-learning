<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://www.data-mining.co.nz/applied-deep-learning/instance_segmentation/mmdetection/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>» MMDetection - Applied Deep Learning</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u00bb MMDetection";
    var mkdocs_page_input_path = "instance_segmentation/mmdetection.md";
    var mkdocs_page_url = "/applied-deep-learning/instance_segmentation/mmdetection/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Applied Deep Learning</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../prerequisites/">Prerequisites</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Image classification</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/mmclassification/">» MMClassification</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/tf2_make_image_classifier/">» tf2_make_image_classifier</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_classification/wai.tfimageclass/">» wai.tfimageclass</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Object detection</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/mmdetection/">» MMDetection</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/yolov5/">» Yolov5</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Instance segmentation</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../detectron2/">» Detectron2</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">» MMDetection</a>
    <ul class="current">
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Image segmentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/image-segmentation-keras/">» Image Segmentation Keras</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/mmsegmentation/">» MMSegmentation</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Applied Deep Learning</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Instance segmentation &raquo;</li>
        
      
    
    <li>» MMDetection</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/waikato-datamining/applied-deep-learning/edit/main/docs/instance_segmentation/mmdetection.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="https://github.com/open-mmlab/mmdetection">MMDetection</a> is a comprehensive and flexible
framework not only for object detection, but also for instance segmentation. Custom docker
images with additional tools are available from here:</p>
<p><a href="https://github.com/waikato-datamining/mmdetection">https://github.com/waikato-datamining/mmdetection</a></p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Make sure you have the directory structure created as outlined in the <a href="../../prerequisites/">Prerequisites</a>.</p>
<h3 id="data">Data</h3>
<p>In this example, we will use the <a href="https://datasets.cms.waikato.ac.nz/ufdl/oxford-pets/">Oxford Pets</a>
dataset, which consists of 37 different categories of cats and dogs.</p>
<p>Download the dataset from the following URL into the <em>data</em> directory and extract it:</p>
<p><a href="https://datasets.cms.waikato.ac.nz/ufdl/data/oxford-pets/oxford-pets-adams.zip">https://datasets.cms.waikato.ac.nz/ufdl/data/oxford-pets/oxford-pets-adams.zip</a></p>
<p>Rename the <code>adams</code> directory to <code>pets-adams</code>. </p>
<p>To speed up training, we only use two labels: <code>cat:abyssinian</code> and <code>dog:yorkshire_terrier</code>.
The label filtering and splitting it into <em>train</em>, <em>validation</em> and <em>test</em> subsets is done 
using <a href="https://github.com/waikato-ufdl/wai-annotations">wai.annotations</a>:</p>
<pre><code class="language-bash">docker run -u $(id -u):$(id -g) \
  -v `pwd`:/workspace \
  -t waikatoufdl/wai.annotations:latest \
  wai-annotations convert \
    from-adams-od \
      -i &quot;/workspace/data/pets-adams/*.report&quot; \
    filter-labels \
      --labels cat:abyssinian dog:yorkshire_terrier \
    discard-negatives \
    coerce-mask \
    to-coco-od \
      -o /workspace/data/pets2-coco-split/annotations.json \
      --sort-categories \
      --category-output-file labels.txt \
      --split-names train val test \
      --split-ratios 70 15 15
</code></pre>
<h3 id="training">Training</h3>
<p>For training, we will use the following docker image:</p>
<pre><code>waikatodatamining/mmdetection:2.24.1_cuda11.1
</code></pre>
<p>The training script is called <code>mmdet_train</code>, for which we can invoke the help screen as follows
(unfortunately, we need to set the <code>MMDET_CLASSES</code> environment variable to avoid an exception):</p>
<pre><code class="language-bash">docker run \
  -e MMDET_CLASSES= \
  -t waikatodatamining/mmdetection:2.24.1_cuda11.1 \
  mmdet_train --help 
</code></pre>
<p>It is good practice creating a separate sub-directory for each training run, with a directory name that hints at
what dataset and model were used. So for our first training run, which will use mainly default parameters, we will 
create the following directory in the <code>output</code> folder:</p>
<pre><code>pets2-mmdet-maskrcnn
</code></pre>
<p>Before we can train, we will need to obtain and customize a config file. Within the container,
you can find example configurations for various architectures in the following directory:</p>
<pre><code>/mmdetection/configs
</code></pre>
<p>Using the <code>mmdet_config</code> command, we can expand and dump one of these configurations for our
own purposes:</p>
<pre><code class="language-bash">docker run \
  -u $(id -u):$(id -g) \
  --gpus=all \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/.cache \
  -v `pwd`/cache/torch:/.cache/torch \
  -t waikatodatamining/mmdetection:2.24.1_cuda11.1 \
  mmdet_config \
  /mmdetection/configs/mask_rcnn/mask_rcnn_r50_fpn_1x_coco.py \
  &gt; output/pets2-mmdet-maskrcnn/mask_rcnn_r50_fpn_1x_coco.py
</code></pre>
<p>Open the <code>mask_rcnn_r50_fpn_1x_coco.py</code> file in a text editor and perform the following operations:</p>
<ul>
<li>remove any lines before <code>model = dict(</code></li>
<li>change all occurrences of <code>num_classes</code> to 2</li>
<li>change <code>dataset_type</code> to <code>Dataset</code> and any occurrences of <code>type</code> in the <code>train</code>, <code>test</code>, <code>val</code> sections of the <code>data</code> dictionary</li>
<li>change <code>data_root</code> occurrences to <code>/workspace/data/pets2-coco-split</code> (the directory above the <code>train</code> and <code>val</code> directories)</li>
<li>change <code>img_prefix</code> occurrences to <code>img_prefix=data_root+'/DIR',</code> with <code>DIR</code> being the appropriate <code>train</code>, <code>val</code> or <code>test</code></li>
<li>change <code>ann_file</code> occurrences to <code>ann_file=data_root+'/DIR/annotations.json',</code> with <code>DIR</code> being the appropriate <code>train</code>, <code>val</code> or <code>test</code></li>
<li>change <code>max_epochs</code> in <code>runner</code> to an appropriate value, e.g., 50</li>
<li>change <code>interval</code> in <code>checkpoint_config</code> to a higher value, e.g., 5</li>
<li>change <code>lr</code> (learning rate) in <code>optimizer</code> to <code>0.002</code> to avoid NaNs with a learning rate that is too high</li>
</ul>
<p>Kick off the training with the following command:</p>
<pre><code class="language-bash">docker run \
  -u $(id -u):$(id -g) \
  --shm-size 8G \
  --gpus=all \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/.cache \
  -v `pwd`/cache/torch:/.cache/torch \
  -e MMDET_CLASSES=/workspace/data/pets2-coco-split/train/labels.txt \
  -t waikatodatamining/mmdetection:2.24.1_cuda11.1 \
  mmdet_train \
  /workspace/output/pets2-mmdet-maskrcnn/mask_rcnn_r50_fpn_1x_coco.py \
  --work-dir /workspace/output/pets2-mmdet-maskrcnn
</code></pre>
<h3 id="predicting">Predicting</h3>
<p>Using the <code>mmdet_predict</code> script, we can batch-process images placed in the <code>predictions/in</code> directory
as follows (e.g., from our <em>test</em> subset): </p>
<pre><code class="language-bash">docker run \
  -u $(id -u):$(id -g) \
  --shm-size 8G \
  --gpus=all \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/.cache \
  -v `pwd`/cache/torch:/.cache/torch \
  -e MMDET_CLASSES=/workspace/data/pets2-coco-split/train/labels.txt \
  -t waikatodatamining/mmdetection:2.24.1_cuda11.1 \
  mmdet_predict \
  --checkpoint /workspace/output/pets2-mmdet-maskrcnn/latest.pth \
  --config /workspace/output/pets2-mmdet-maskrcnn/mask_rcnn_r50_fpn_1x_coco.py \
  --prediction_in /workspace/predictions/in \
  --prediction_out /workspace/predictions/out
</code></pre>
<p><strong>Notes</strong> </p>
<ul>
<li>The predictions get output in <a href="https://github.com/waikato-ufdl/wai-annotations-roi">ROI CSV format</a>.</li>
<li>You can view the predictions with the ADAMS <em>Preview browser</em> and, e.g., the <em>ObjectLocationsFromSpreadSheet</em>
  handler. You need to configure this generic handler via the <code>...</code> button, entering the columns 
  for the bounding box (<code>x0</code>, <code>y0</code>, <code>x1</code>, <code>y1</code>), the polygon coordinates (<code>poly_x</code> and <code>poly_y</code>) and the 
  label (<code>label_str</code>) of the <code>reader</code> (<code>ObjectLocationsSpreadSheetReader</code>).</li>
</ul>
<p><strong>Example prediction</strong></p>
<p><img alt="Screenshot" src="../img/mmdet-Abyssinian_117.png" /> <img alt="Screenshot" src="../img/mmdet-Abyssinian_117-overlay.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../image_segmentation/" class="btn btn-neutral float-right" title="Introduction">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../detectron2/" class="btn btn-neutral" title="» Detectron2"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/waikato-datamining/applied-deep-learning/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../detectron2/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../image_segmentation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
