<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://www.data-mining.co.nz/applied-deeplearning/image_classification/wai.tfimageclass/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>wai.tfimageclass - Applied Deep Learning</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "wai.tfimageclass";
    var mkdocs_page_input_path = "image_classification/wai.tfimageclass.md";
    var mkdocs_page_url = "/applied-deeplearning/image_classification/wai.tfimageclass/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Applied Deep Learning</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../prerequisites/">Prerequisites</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Image classification</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mmclassification/">MMClassification</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../wai.pytorchimageclass/">wai.pytorchimageclass</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">wai.tfimageclass</a>
    <ul class="current">
    </ul>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Object detection</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/mmdetection/">MMDetection</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../object_detection/yolov5/">Yolov5</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Instance segmentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../instance_segmentation/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../instance_segmentation/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../instance_segmentation/detectron2/">Detectron2</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Image segmentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/">Introduction</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/annotate/">Annotate</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/image-segmentation-keras/">Image Segmentation Keras</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/mmsegmentation/">MMSegmentation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../image_segmentation/segmentation_models/">Segmentation models</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Applied Deep Learning</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Image classification &raquo;</li>
        
      
    
    <li>wai.tfimageclass</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>The <a href="https://github.com/waikato-datamining/tensorflow/tree/master/image_classification">wai.tfimageclass</a> Python library
(<a href="https://pypi.org/project/wai.tfimageclass/">PyPI</a>) can be used for training various models that are available from 
the <a href="https://tfhub.dev/">Tensorflow Hub</a>.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Make sure you have the directory structure created as outlined in the <a href="../../prerequisites/">Prerequisites</a>.</p>
<h3 id="data">Data</h3>
<p>In this example, we will use the <a href="http://datasets.cms.waikato.ac.nz/ufdl/image_classification/102flowers/">102 flowers</a>
dataset, which consists of 102 different categories (~ species) of flowers. More precisely, we will download the
dataset with the flowers already split into categories from which will use a subset to speed up the training process.</p>
<p>Download the dataset from the following URL and extract it:</p>
<p><a href="https://datasets.cms.waikato.ac.nz/ufdl/data/102flowers/102flowers-subdir.zip">https://datasets.cms.waikato.ac.nz/ufdl/data/102flowers/102flowers-subdir.zip</a></p>
<p>Once extracted, you can delete all sub-directories apart from:</p>
<ul>
<li>alpine_sea_holly</li>
<li>anthurium</li>
<li>artichoke</li>
</ul>
<p>Rename the <code>subdir</code> directory to <code>3flowers</code> and move it into the <code>data</code> folder of our directory structure 
outlined. </p>
<h3 id="training">Training</h3>
<p>For training, we will use the following docker image:</p>
<pre><code>waikatodatamining/tf_image_classification:1.14
</code></pre>
<p>If you only have a CPU machine available, then use this one instead:</p>
<pre><code>waikatodatamining/tf_image_classification:1.14_cpu
</code></pre>
<p>The training script is called <code>tfic-retrain</code>, for which we can invoke the help screen as follows:</p>
<pre><code class="language-bash">docker run -t waikatodatamining/tf_image_classification:1.14 tfic-retrain --help      # GPU
docker run -t waikatodatamining/tf_image_classification:1.14_cpu tfic-retrain --help  # CPU
</code></pre>
<p>It is good practice creating a separate sub-directory for each training run, with a directory name that hints at
what dataset and model were used. So for our first training run, which will use mainly default parameters, we will 
create the following directory in the <code>output</code> folder:</p>
<pre><code>3flowers-default
</code></pre>
<p>The following command, issued in the <code>applied_deep_learning</code> directory, will map the <code>applied_deep_learning</code>
directory (= the current working directory) onto the <code>/workspace</code> directory within the docker container, giving
us access to all the sub-directories there, and train our 3flowers dataset (<code>-u $(id -u):$(id -g)</code> maps the user 
and group ID):</p>
<p>GPU:</p>
<pre><code class="language-bash">docker run \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/tmp/tfhub_modules
  -u $(id -u):$(id -g) \
  --gpus=all \
  -t waikatodatamining/tf_image_classification:1.14 \
  tfic-retrain \
  --image_dir /workspace/data/3flowers \
  --output_graph /workspace/output/3flowers-default/graph.pb \
  --output_info /workspace/output/3flowers-default/graph.json \
  --saved_model_dir /workspace/output/3flowers-default/saved_model \
  --image_lists_dir /workspace/output/3flowers-default \
  --training_steps 500
</code></pre>
<p>CPU:</p>
<pre><code class="language-bash">docker run \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/tmp/tfhub_modules
  -u $(id -u):$(id -g) \
  -t waikatodatamining/tf_image_classification:1.14_cpu \
  tfic-retrain \
  --image_dir /workspace/data/3flowers \
  --output_graph /workspace/output/3flowers-default/graph.pb \
  --output_info /workspace/output/3flowers-default/graph.json \
  --saved_model_dir /workspace/output/3flowers-default/saved_model \
  --image_lists_dir /workspace/output/3flowers-default \
  --training_steps 500
</code></pre>
<h3 id="exporting-model">Exporting model</h3>
<p>Before we can use the model, we need to export it to <em>Tensorflow lite</em> or <em>tflite</em>:</p>
<p>GPU:</p>
<pre><code class="language-bash">docker run \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/tmp/tfhub_modules
  -u $(id -u):$(id -g) \
  --gpus=all \
  -t waikatodatamining/tf_image_classification:1.14 \
  tfic-export \
  --saved_model_dir /workspace/output/3flowers-default/saved_model \
  --tflite_model /workspace/output/3flowers-default/graph.tflite
</code></pre>
<p>CPU:</p>
<pre><code class="language-bash">docker run \
  -v `pwd`:/workspace \
  -v `pwd`/cache:/tmp/tfhub_modules
  -u $(id -u):$(id -g) \
  -t waikatodatamining/tf_image_classification:1.14_cpu \
  tfic-export \
  --saved_model_dir /workspace/output/3flowers-default/saved_model \
  --tflite_model /workspace/output/3flowers-default/graph.tflite
</code></pre>
<h3 id="predicting">Predicting</h3>
<p>For making predictions for a single image, you can use the script <code>tfic-labelimage</code>.</p>
<p>Since we will want to batch predict multiple images, will use the script <code>tfic-poll</code> instead: </p>
<p>GPU:</p>
<pre><code class="language-bash">docker run \
  -v `pwd`:/workspace \
  -u $(id -u):$(id -g) \
  -t waikatodatamining/tf_image_classification:1.14 \
  tfic-poll \
  --graph /workspace/output/3flowers-default/graph.tflite \
  --graph_type tflite \
  --info /workspace/output/3flowers-default/graph.json \
  --in_dir /workspace/predictions/in \
  --out_dir /workspace/predictions/out
</code></pre>
<p>CPU:</p>
<pre><code class="language-bash">docker run \
  -v `pwd`:/workspace \
  -u $(id -u):$(id -g) \
  -t waikatodatamining/tf_image_classification:1.14_cpu \
  tfic-poll \
  --graph /workspace/output/3flowers-default/graph.tflite \
  --graph_type tflite \
  --info /workspace/output/3flowers-default/graph.json \
  --in_dir /workspace/predictions/in \
  --out_dir /workspace/predictions/out
</code></pre>
<p>E.g., for the <code>image_01965.jpg</code> from the <code>anthurium</code>, we will get a CSV file similar to 
<a href="../img/image_01965.csv">this one</a>:</p>
<table>
<thead>
<tr>
<th align="left">label</th>
<th align="right">probability</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">anthurium</td>
<td align="right">0.989429</td>
</tr>
<tr>
<td align="left">artichoke</td>
<td align="right">0.0060946</td>
</tr>
<tr>
<td align="left">alpine_sea_holly</td>
<td align="right">0.00447612</td>
</tr>
</tbody>
</table>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../object_detection/" class="btn btn-neutral float-right" title="Introduction">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../wai.pytorchimageclass/" class="btn btn-neutral" title="wai.pytorchimageclass"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../wai.pytorchimageclass/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../object_detection/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
